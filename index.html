<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crea Sondaggio</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; margin-bottom: 20px; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; justify-content: center; }
    .filter-buttons { text-align: center; margin: 10px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    input, button, select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; }
    button { background: #ff7e5f; color: white; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { background: #eb5757; }
    .list { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 10px; 
      max-height: 70vh; 
      overflow-y: auto; 
      padding-right: 5px; 
    }
    .card { 
      background: white; padding: 15px; border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
      display: flex; gap: 10px; align-items: flex-start;
    }
    .card input[type="checkbox"] { margin-top: 5px; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      min-width: 150px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
    }
    .dropdown.show .dropdown-content { display: block; }
    .dropdown-content label { display: block; cursor: pointer; margin: 3px 0; }

    /* Loader */
    #loader {
      display:flex;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(255,255,255,0.7);
      align-items:center; justify-content:center;
      z-index:9999;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #ff7e5f;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Seleziona i locali da proporre ai tuoi amici<br>e premi su Fatto quando hai finito</h1>

  <!-- FILTRI -->
  <div class="filters">
    <div class="dropdown" id="zonaFilter"><div class="dropdown-btn">Zone...</div></div>
    <div class="dropdown" id="tipoFilter"><div class="dropdown-btn">Tipi...</div></div>
    <div class="dropdown" id="consigliatoFilter"><div class="dropdown-btn">Consigliato...</div></div>
    <div class="dropdown" id="glutenFilter"><div class="dropdown-btn">Gluten...</div></div>
  </div>

  <!-- BARRA DI RICERCA -->
  <div class="filters">
    <input type="text" id="searchInput" placeholder="Cerca locale..." oninput="cercaPerNome()">
  </div>

  <!-- Pulsanti principali -->
  <div class="filter-buttons">
    <button onclick="filtra()">Filtra</button>
    <button onclick="generaSondaggio()">Fatto ✅</button>
    <button onclick="window.location.href='https://maurodigirola.github.io/locali/Locali_Firenze_04.html'">Indietro 🔙</button>
  </div>

  <!-- LISTA -->
  <div class="list" id="lista"></div>

  <!-- Loader -->
  <div id="loader"><div class="spinner"></div></div>

  <script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyf88jHp8K5e9eZEkoE6mtauZEnpGyiWOAv0rkgLPoPg4MbailJOAPuUuuYjbiVcjUl/exec";
  let myName = localStorage.getItem("myName") || "Anonimo";
  let locali = [];

  async function carica() {
    try {
      mostraLoader();
      const res = await fetch(SCRIPT_URL);
      locali = await res.json();
      aggiornaFiltri();
      mostra();
    } catch(err) {
      console.error("Errore caricamento:", err);
    } finally {
      nascondiLoader();
    }
  }

  function mostra(lista = locali) {
    const c = document.getElementById("lista");
    c.innerHTML = "";
    lista.forEach((loc, i) => {
      c.innerHTML += `
        <div class="card">
          <input type="checkbox" class="checkSondaggio" value="${i}">
          <div>
            <strong>${loc.nome}</strong> ${loc.glutenFree==="si" ? "🌾🚫" : ""}<br>
            Zona: ${loc.zona} <br>
            Tipo: ${loc.tipo} <br>
            <a href="${loc.link}" target="_blank">Link</a>
          </div>
        </div>`;
    });
  }

  // --- Dropdown filtri ---
  function creaDropdown(id, titolo, valori) {
    const unici = [...new Set(valori.flatMap(v => v.split("+")))].filter(v => v);
    const div = document.getElementById(id);
    div.innerHTML = `
      <div class="dropdown-btn" data-titolo="${titolo}" onclick="toggleDropdown('${id}', event)">${titolo}</div>
      <div class="dropdown-content">
        <label><input type="checkbox" value="__ALL__" checked onchange="selezionaTutti('${id}', this)"> Tutti</label>
        ${unici.map(v => `<label><input type="checkbox" value="${v}" onchange="aggiornaTesto('${id}')"> ${v}</label>`).join("")}
      </div>
    `;
    div.querySelector(".dropdown-content").addEventListener("click", e => e.stopPropagation());
  }

  function aggiornaFiltri() {
    const zone = locali.map(l => l.zona);
    const tipi = locali.map(l => l.tipo);
    const cons = [...new Set(locali.map(l => l.consigliatoDa || "—"))];
    const gf = ["si","no"];
    creaDropdown("zonaFilter", "Tutte le zone", zone);
    creaDropdown("tipoFilter", "Tutti i tipi", tipi);
    creaDropdown("consigliatoFilter", "Tutti i consiglieri", cons);
    creaDropdown("glutenFilter", "Gluten free", gf);
  }

  function getSelezionati(id) {
    return [...document.querySelectorAll(`#${id} .dropdown-content input:checked`)]
      .map(cb => cb.value)
      .filter(v => v !== "__ALL__");
  }

  function filtra() {
    const zone = getSelezionati("zonaFilter");
    const tipi = getSelezionati("tipoFilter");
    const cons = getSelezionati("consigliatoFilter");
    const gf = getSelezionati("glutenFilter");

    const f = locali.filter(l =>
      (zone.length === 0 || zone.includes(l.zona)) &&
      (tipi.length === 0 || tipi.some(t => l.tipo.split("+").includes(t))) &&
      (cons.length === 0 || cons.includes(l.consigliatoDa || "—")) &&
      (gf.length === 0 || gf.includes(l.glutenFree))
    );
    mostra(f);
  }

  // --- Ricerca per nome ---
  function cercaPerNome() {
    const query = document.getElementById("searchInput").value.toLowerCase().trim();
    const filtrati = locali.filter(l => l.nome.toLowerCase().includes(query));
    mostra(filtrati);
  }

  // --- Gestione dropdown ---
  function toggleDropdown(id, event) {
    event.stopPropagation();
    document.querySelectorAll(".dropdown").forEach(d => { if (d.id !== id) d.classList.remove("show"); });
    document.getElementById(id).classList.toggle("show");
  }
  document.addEventListener("click", (e) => {
    if (!e.target.closest(".dropdown")) {
      document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("show"));
    }
  });

  function aggiornaTesto(id) {
    const btn = document.querySelector(`#${id} .dropdown-btn`);
    const selezionati = getSelezionati(id);
    if (selezionati.length === 0) btn.textContent = btn.dataset.titolo;
    else if (selezionati.length === 1) btn.textContent = selezionati[0];
    else btn.textContent = selezionati.length + " selezionati";
  }
  function selezionaTutti(id) {
    document.querySelectorAll(`#${id} .dropdown-content input[type="checkbox"]`).forEach(cb => {
      if (cb.value !== "__ALL__") cb.checked = false;
    });
    aggiornaTesto(id);
  }

  // --- Genera messaggio ---
  function generaSondaggio() {
    const selezionati = [...document.querySelectorAll(".checkSondaggio:checked")].map(cb => locali[cb.value]);
    if (selezionati.length === 0) {
      alert("Seleziona almeno un locale!");
      return;
    }

    let msg = "Dove andiamo a mangiare? 🍽️\n\n";
    selezionati.forEach((loc, i) => {
      msg += `${i+1}. ${loc.nome} - ${loc.zona} (${loc.tipo})\n${loc.link}\n\n`;
    });

    const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank");

    document.querySelectorAll(".checkSondaggio").forEach(cb => cb.checked = false);
    aggiornaFiltri();
    mostra(locali);
  }

  function mostraLoader() { document.getElementById("loader").style.display = "flex"; }
  function nascondiLoader() { document.getElementById("loader").style.display = "none"; }

  carica();
  </script>
</body>
</html>
